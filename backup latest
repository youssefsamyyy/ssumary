const express = require('express');
const { VertexAI } = require('@google-cloud/vertexai');
const cors = require('cors');
const multer = require('multer');
const pdfParse = require('pdf-parse');
const path = require('path');
const rateLimit = require('express-rate-limit');
require('dotenv').config();

const app = express();
const port = process.env.PORT || 3006;

// Validate environment variables
const requiredEnvVars = ['GCLOUD_PROJECT_ID', 'GCLOUD_LOCATION', 'GOOGLE_APPLICATION_CREDENTIALS'];
for (const envVar of requiredEnvVars) {
  if (!process.env[envVar]) {
    console.error(`Error: Missing required environment variable ${envVar}`);
    process.exit(1);
  }
}

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100,
  message: { error: "Too many requests, please try again later" }
});

// Middleware
app.use(cors());
app.use(express.json());
app.use(limiter);
app.use(express.static(path.join(__dirname, 'public')));

// File upload configuration
const upload = multer({
  storage: multer.memoryStorage(),
  limits: { fileSize: 25 * 1024 * 1024 },
  fileFilter: (req, file, cb) => {
    if (file.mimetype === 'application/pdf') {
      cb(null, true);
    } else {
      cb(new Error('Only PDF files are allowed'), false);
    }
  }
});

// Initialize Vertex AI
const vertexAI = new VertexAI({
  project: process.env.GCLOUD_PROJECT_ID,
  location: process.env.GCLOUD_LOCATION
});

// Initialize the model - Use Gemini 1.5 Pro (or a newer version if available)
const model = vertexAI.getGenerativeModel({
  model: "gemini-1.5-pro-002", //  Gemini 1.5 Pro.  Check Google Cloud documentation for the LATEST model name.
  generationConfig: {
    temperature: 0.7, // Good for focused, less random output.
    topP: 0.95,      // Controls diversity of tokens considered.
    maxOutputTokens: 4096, // Adjust as needed.  Gemini 1.5 Pro supports large context windows.
  },
   safetySettings: [
    {category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE'}, //Use more restrict safety settings.
    {category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE'},
    {category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE'},
    {category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE'},
  ],
});

// Text correction endpoint
app.post('/correctText', async (req, res) => {
  try {
    const { text } = req.body;

    if (!text) {
      return res.status(400).json({ error: "No text provided" });
    }

    const prompt = `You are an expert in Arabic linguistics and sociolinguistics, specializing in expressions related to children. Your task is to analyze an Arabic paragraph and correct any expressions that convey inaccurate or harmful social interpretations about children.

Instructions:

1. Carefully analyze the provided Arabic paragraph.
2. Identify any expressions related to children that convey inaccurate or harmful societal interpretations.
3. Ensure the corrected paragraph maintains the original meaning and context as much as possible.
4. Output the corrected Arabic paragraph.
5. Do not use english words in your reply.
6. Example : تناقش التقارير الدولية ظاهرة استخدام أطفال انتحاريون في الصراعات المسلحة.
Correction: تناقش التقارير الدولية ظاهرة استخدام أطفال يتم استغلالهم في عمليات انتحارية في الصراعات المسلحة
7. mention the wrong sentence and your correction
8. Explain your correction.
9. Follow this principales:
أولاً :المبادئ المهنية العامة لمعالجة الإعلام العربى قضايا حقوق الطفل:
المساواة وعدم التمييز- حرية الرأى والتعبير – المصداقية والوضوح – الموضوعية – حماية مصلحة الطفل الفضلى- حماية الهوية الشخصية، وضمان الحق فى الخصوصية- حق الرد والتصحيح.
من أهم ما يقتضتيه التزام هذه المبادئ:
-	الاعتماد فى عمل وسائل الإعلام - في كل مراحل الإنتاج - على احترام حقوق الطفل، والتوجه لشمول الأطفال على اختلافهم .
-	تجنب التمييز بين الأطفال؛ بسبب النوع، أو العرق، أو السن، أو الدين، أو الخلفية الثقافية، أو الحالة التعليمية، أو قدراتهم البدنية،أو الذهنية.
-	إتاحة الفرص للمشاركة في وسائل الإعلام للأطفال كافة؛ من خلال الإسهام بالرأي ،أو الإنتاج الفني، أو الأدبي، أو حتى مجرد الاستفسار.
-	تحرى الدقة فى جميع الأخبار؛ فلا تحتوى معلومات كاذبة، ولا شائعات، ولا حقائق مشوهة، ولا معلومات تمييزية، ولا متحيزة، يمكن أن تشكل ضرراً للأطفال.
-	الحرص على الإنصاف للأطراف كافة، وتجنب الإغراءات، وتضارب المصالح.
-	الابتعاد عن التعميم؛ سواء أكان ما ينشر حالات فردية، أم ظاهرة منتشرة بناء على إحصاءات علمية.
-	منح الجمهور الفرصة لاستقاء المعلومات عن واقع الأطفال من سياقها المحدد، وإخباره بطبيعة المعلومات المطروحة عليه ؛ من حيث كونها حقيقية، أم تعليقاً ،أم رأياً شخصياً.
-	تجنب استخدام القوالب النمطية، والعرض المثير للترويج للمواد الإعلامية المرتبطة بالأطفال، أو الطلب إليهم رواية قصة، أو أداء عمل لا يشكل جزءاً من تاريخهم، ولا حياتهم. 
-	الحذر من إلحاق الأذى بأي طفل، وتجنب الأسئلة والمواقف والتعليقات المتسرعة في الأحكام، أو ذات الحساسية الثقافية أو الاجتماعية، أو التي تضعه في خطر، أو تعرضه للإهانة، أو التي تبعث في نفسه الألم والحزن الناجمين عن أحداث، أو ذكريات مؤلمة.
-	التمسك بمراعاة الذوق العام، والاحتشام، والبعد عن عرض صور جثث القتلى، أو الإصابات والتشوهات الجسمية، وفقدان الأطراف، وذكر أوصاف مخيفة للموت، أو القتل؛ مما يؤثر فى نفسية  الأطفال.
-	التصدى لأى ممارسات تنتهك حقوق الطفل، أو تسيء إليه، وتشجيع الجهود المحلية والإقليمية والدولية لحماية هذه الحقوق.
-	الامتناع عن نشر أي قصة إخبارية، أو خبر إعلامي، أو صورة يمكن أن تُعرّض الطفل، أو أشقاءه، أو أقرانه للخطر، أو الإساءة حتى عندما يتم تغيير هوية الطفل، أو طمسها، أو عدم استخدامها.
-	الحرص بشكل دائم على تغيير أسماء الأطفال، وطمس هوياتهم المرئية في الحالات التالية:     
أ: 	الأطفال ضحايا جرائم الاعتداء الجنسي، والاستغلال، أو مرتكبوها .
ب: الأطفال المصابون بفيروس نقص المناعة البشرية "الإيدز". 
ج: الأطفال المتهمون، أو المدانون بارتكاب جريمة.
د: 	تعريف الطفل بصفته مقاتلاً فى حروب، أو صراعات؛ سواء أكان في الوقت الحاضر أم سابقاً، أم ‌طالباً للجوء السياسي، أم لاجئاً، أم مشرّداً داخل وطنه، أم طفلاً من أطفال الشوارع. 
-	طلب الإذن من الطفل، والوصي عليه؛ سواء أسرته، أو غيرهم؛ لإجراء جميع المقابلات، والتصوير على شريط الفيديو، والتقاط الصور التوثيقية عندما يكون ذلك ممكناً، ويجب أن يكون هذا الإذن مكتوباً كلما أمكن ذلك.
-	إتاحة الفرص لأطراف أي قصة خبرية، أو قضية تتعلق بالطفل؛ لتوضيح مواقفهم، والرد على أي اتهام موجه إليهم، أو قولٍ، أو فعلٍ يرون أنه نسب إليهم خطأ، أو بصورة مشوهة.

ثانياً: المبادئ المهنية لمشاركة الأطفال فى إنتاج المحتوى الإعلامى:
الحماية خلال عملية المشاركة- توفير مناخ إيجابى داعم للمشاركة- حرية تكوين الرأى والتعبير عنه- العدالة فى المشاركة.
من أهم ما يقتضيه التزام هذه المبادئ:
-	الحرص على حماية مصلحة الطفل الفضلى فى أثناء مشاركته الإعلامية؛ بما يضمن حمايته من التعرض للأخطار المختلفة التى قد تؤثر فى سلامته البدنية، أو الذهنية، أو النفسية. 
-	تجنب مشاركة الأطفال فى مشاهد تحتوى عنفاً بدنياً، أو لفظياً، أو محتوى غير ملائم لتقاليد المجتمع وأعرافه.
-	توخى الحذر إزاء استضافة الأطفال ضحايا العنف بأنواعه كافة - بما فيها الاعتداءات الجنسية- بما يضمن حق الطفل فى الحماية من الاستغلال، والحفاظ على حقه الكامل فى سرية حياته الشخصية وخصوصيتها.
-	تخير الأوقات المناسبة لمشاركة الأطفال فى المحتوى الإعلامى ؛ بما لا يتعارض مع التزاماتهم الدراسية، ويحترم حقهم فى التعليم.
-	منح الأطفال الوقت الكافى لكى يعبروا عن مشكلاتهم وقضاياهم.
-	تجنب التفرقة فى مشاركة الأطفال فى إنتاج البرامج، والمواد الإعلامية على أساس العمر، أوالنوع أو المستوى الاقتصادى والاجتماعى.

ثالثاً: المبادئ المهنية للتغطية الإخبارية للأطفال ضحايا الاعتداءات الجنسية (أو مرتكبيها) والنزاعات والحروب:
حماية الخصوصية- الأمان والحماية-  دقة التغطية الإعلامية وعمقها- الشفافية والمصداقية فى مقابلة الأطفال-   سلامة المفردات والتركيبات اللغوية- التوعية - عدم الاستغلال السياسى.
من أهم ما يقتضيه التزام هذه المبادئ:
-	العناية عند الإبلاغ عن الاعتداء الجنسي بتحقيق التوازن بين حق الضحية في الخصوصية، وحق الجمهور في المعرفة.
-	تجنب تضمين التغطية الإعلامية للاعتداءات على الأطفال تفاصيل محرجة، تخترق خصوصية حياتهم الشخصية، ربما تصل إلى مرحلة الإيذاء؛ مثل: وصف تفاصيل دقيقة عن الأفعال المادية التي ارتكبت خلال التعرض للإساءة، والاعتداء الجنسي.
-	تجنب التفاصيل التي يمكن أن تعرض الضحية للخطر؛ مثل: ذكر عناوين المنزل، وأرقام الهواتف، وأماكن العمل، والبعد عن الصورة النمطية للضحايا، وخاصة في حالات الجريمة الجنسية.
-	منح الفرص للضحايا وأسرهم لقبول التغطية الإعلامية، أو رفضها دون الترهيب باستخدام قوة وسائل الإعلام، أو تهديد الضحايا إذا رفضوا ذلك؛ فلا يوجد أي إلزام للضحايا فى منح هذه التغطية.
-	وضع القصص الإخبارية حول الطفل ضحية الجريمة في السياق المناسب، وتناول وقائع الجريمة في الإطار الذى يوفر لها المعنى والوضوح، وعدم تعميم الحوادث الفردية؛ لأن ذلك قد يؤدى إلى انتشار الجريمة بصورة واسعة النطاق برغم محدودية حدوثها. 
-	تجنب ذكر معلومات كاذبة أو مضللة، أو بث الإشاعات، أو الاعتماد على المعلومات مجهولة المصادر بشأن  الاتهامات وسير التحقيقات التي يمكن أن تقدم حتى من قبل الطفل الضحية، وتوخي الحذر في تسمية المشتبه فيهم قبل الاتهام الرسمى من السلطات القضائية.
-	التحقق من مدى أهمية، وضرورة تضمين التقرير الإعلامى التفاصيل الأليمة حول طبيعة الاغتصاب، أو العنف، أو الإصابات، وتحليل مدى تأثير هذه التفاصيل فى القراء، أو المشاهدين، والأطراف الأخرى.
-	تجنب استخدام الأوصاف الجنسية الصريحة، أو الصور التى قد تطبع مثل هذا السلوك في ذهن الطفل المتلقى؛ فيؤدي ذلك إلى الانخراط في النشاط الجنسي في سن مبكرة.
-	أداء دور فاعل وإيجابى في لفت الانتباه إلى محنة الأطفال ومعاناتهم فى أثناء الصراعات المسلحة وما يليها، والإسهام فى دعم إنتاج ونشر برامج إعلامية، تستهدف الأطفال المتضررين من الحرب.
-	التحقق من أن عمل وسائل الإعلام خلال فترات الحروب والنزاعات يقوم على توفير الحماية للأطفال، والإسهام فى إعادة تأهيلهم، وإدماجهم فى المجتمع؛ لتجاوز الآثار النفسية والاجتماعية للحروب.
-	حماية الأطفال من التعرض للصور التلفزيونية المزعجة بشكل مكثف أو مخيف ؛ فبعض الأطفال أكثر عرضة للقلق بشأن الأحداث التي تغطيها وسائل الإعلام؛ نتيجة عوامل مختلفة تؤثر فى ردود أفعالهم ؛ منها: السن، والمزاج الانفعالى، والميل إلى القلق. 
-	تأكيد النتائج الإيجابية التي قد تنشأ نتيجة الأحداث المؤلمة؛ ومنها: التضامن، وصناعة الأبطال، وقيمة الحياة، ودور الإنسان فى التخفيف من معاناة الآخرين وآلامهم.
-	تجنب الاستغلال السياسى، والإعلامى لمعاناة الأطفال وآلامهم من جراء الحروب؛ بإعلان انحيازهم لطرف على حساب طرف آخر داخل الصراع، أو مطالبتهم بعرض أفكار وتوجهات لا تتلاءم مع قدراتهم الذهنية، ولا المرحلة العمرية التى يمرون بها، ولا خبراتهم ولا تجاربهم السابقة. 
-	تجنب استغلال الأطفال المتضررين من الحرب؛ لأسباب اقتصادية وسياسية خاصة بهم، وينبغي أن تركز وسائل الإعلام على نقاط القوة المحتملة، وقدرات الأطفال المتأثرين بالحرب؛ بدلا من الاقتصار - فقط - على تصويرهم ضحايا فحسب. 

رابعاً المبادئ المهنية للتعامل الإعلامى مع الإعلانات التى تستهدف الأطفال:
الواقعية- الأمان والحماية- سيادة المعايير الاجتماعية- تقدير الأسرة.
  
 من أهم ما يقتضيه التزام هذه المبادئ:
-	الحرص على ألا يضلل الإعلان الأطفال ولا يخدعهم  بانطباعات خاطئة فى أذهانهم عن طبيعة، أو محتوى، و سعر السلعة، أو المنتج، وتأثيرها فيهم.
-	التحقق من أن الاعلان لا يحتوى أموراً غامضة؛ كأن يشمل رسوماً، أو عبارات غير دقيقة، أو خادعة، تقدم بشكل مباشر، أو ضمنى، أو يستغل خيال الطفل لحثه على زيادة استهلاكه من المنتج.
-	عدم استغلال نقص المعلومات لدى الأطفال، ولا براءتهم، ولاقلة خبرتهم؛ عن طريق عرض معلومات من الممكن أن تؤذيهم جسمياً أو نفسياً.
-	الالتزام بألا يحتوى الإعلان معلومات خاطئة عن القيمة الغذائية للمنتج، أو يعرض مقارنات غير صحيحة، أو مضللة بينه، وبين غيره من المنتجات.
-	الحرص على أن تكون الشهادات والآراء المقدمة فى الإعلان عن المنتج حقيقية، وألا تكون خادعة، ولا مبالغاً فيها، وأن تتفق مع أحدث الآراء العلمية المقبولة.
-	الحرص على ألا يقدم الإعلان صوراً، ولا أحداثاً مخيفة، ولا محزنة للأطفال، ولا يشجعهم على تبنى سلوكيات عنيفة، ولا قيم تتعارض مع ثقافة المجتمع.
-	الالتزام بألا يحط الإعلان من قدر وكرامة شخص ولا مجموعة ؛ على أساس العرق، أو النوع، أو العمر، أو المعتقد السياسى، أو الدين، أو حالة العجز الطبيعى أو الذهنى.
-	الحرص على ألا يعمل الإعلان على إضعاف سلطة الوالدين، أو مسئولياتهما، وثقة الطفل بأسرته.
-	الالتزام بأن تكون الأسعار المذكورة بالإعلان واضحة، ومفهومة للأطفال بطريقة لا لبس فيها، وألا يوحى أن المنتج المعلن عنه فى متناول أيدى جميع الأسر.

خامساً: المبادئ المهنية لتعامل الإعلام مع قضايا حقوق الطفل فى الإعلام الجديد (مواقع التواصل الاجتماعى – المدونات الإلكترونية – المواقع الإلكترونية):
صحة المضمون الإعلامى - الإفصاح والشفافية - خصوصية التعامل الإعلامى.
من أهم ما يقتضيه التزام هذه المبادئ:
-	الحذر تجاه ما يروج له حول قضايا الأطفال، والحرص على البحث عن المعلومات والبيانات وفق أكثر من مصدر؛ للتأكد من صحتها ودقتها.
-	بذل قصارى الجهد للتحقق من دقة الصور وملفات الفيديو التى يتم تداولها عبر مواقع التواصل الاجتماعى من خلال أشخاص عاديين، ويتم نشرها  ومشاركتها عبر الإنترنت من قبل الأفراد، وعندما يكون هناك شك حيالها يجب الامتناع عن نشرها.
-	الإعلان عن الهوية الحقيقية للإعلامى، والجهة التى يعمل بها عند طرح الأسئلة حول قضايا حقوق الطفل عبر مواقع التواصل الاجتماعى، وتجنب استخدام أسماء مستعارة عند أداء أى عمل إعلامى.
-	تجنب نشر مواد إعلامية عبر مواقع التواصل الاجتماعى تحض على الكراهية أو العنف، أو التمييز بين الأطفال على أساس اللغة، أو النوع، أو العرق، أوالدين.
-	إعلان مصدر المعلومات الذى اعتمد عليه، ويفضل أن يُرفق رابط، يستطيع منه القارئ التأكد من صحة المعلومة التى يتم تداولها عبر مواقع التواصل الاجتماعى، أو المواقع الإلكترونية بشكل عام.
-	احترام حقوق الملكية الفكرية للأشخاص والمؤسسات والمنظمات المختلفة؛ فبرغم الفيض المعرفى المتنوع - والمجانى غالباً - الذى يتيحه الفضاء الإلكترونى؛ تبقى المحافظة على ملكية الأفكار من أهم المبادئ المهنية المتعارف عليها لدى المشتغلين بالعمل الإعلامى.
-	الاعتذار فوراً فى حالة الخطأ فى نشر معلومات عبر مواقع التواصل الاجتماعى تخص قضايا عامة، أو تتعلق بالأطفال وتصحيحها؛ فمتصفحو مواقع التواصل الاجتماعى - وبخاصة موقعا:" الفيس بوك" Facebook ،و"تويتر"Twitter - يحفظون على أجهزتهم الشخصية ما يتم تداوله عبر مواقع التواصل الاجتماعى؛ ومن ثم من الأفضل بعد حذف المواد المزيفة أو الخطأ أن  تعتذر للجمهور عن المحتوى الذى تم نشره.

سادساً: المبادئ المهنية لتعامل الإعلام مع الأطفال ذوى الإعاقة :
عدم التمييز- الدعم والمساندة- الدمج.
من أهم ما يقتضيه التزام هذه المبادئ:
-	الحرص على حث أفراد المجتمع ومؤسساته على تنمية التفاعل مع الأطفال ذوى الإعاقة، وزيادة الوعى بحقوقهم، وأنهم يتساوون مع أي طفل آخر في المجتمع في الواجبات والحقوق.  
-	إتاحة الفرص أمام الأطفال ذوى الإعاقة للتواصل، والتعبير بحرية عن آرائهم ومشكلاتهم.
-	تجنب تعزيز الصور السلبية أو القوالب النمطية للأطفال ذوى الإعاقة التى تسهم فى عزلتهم.
-	إبراز النماذج الناجحة، والجوانب الإيجابية، والقدرات الخاصة للأطفال ذوى الإعاقة، وكيفية الإفادة منهم. 
-	الحرص على التناول المكثف والموضوعى لانتهاكات حقوق الأطفال ذوى الاعاقة،والحذر من إهاناتهم، أو تشويه سمعتهم.  
-	العمل من خلال آليات مختلفة على توعية الجمهور بقضايا الأطفال ذوى الإعاقة؛ بوصفها قضايا حقوق الإنسان بشكل عام، وحقوق الطفل على وجه الخصوص.
-	إلقاء الضوء على النماذج الإيجابية، والناجحة فى دمج الأطفال ذوى الإعاقة تربوياً وتعليمياً مع قرنائهم العاديين.

سابعاً :المبادئ المهنية لتعامل الإعلام مع الأطفال الموهوبين 
التوعية والاكتشاف – الدعم والرعاية.
من أهم ما يقتضيه التزام هذه المبادئ:
-	إعداد برامج ومواد إعلامية مناسبة ومختلفة  تستهدف الجمهور، وبخاصة أولياء الأمور  وتتناول التعريف بالأطفال الموهوبين، وخصائصهم وإمكاناتهم، وكيفية اكتشافهم. 
-	الحرص على دعم البرامج والفاعليات الإعلامية المختلفة التى تسهم فى اكتشاف المواهب بين الأطفال ليس فى مجالات بعينها؛ وإنما فى المجالات كافة.
-	زيادة العناية بالمحتوى الإعلامى العلمى والثقافى والفنى والرياضى الموجه إلى الأطفال الموهوبين فى إطار دعم هؤلاء الأطفال ورعايتهم، وتطوير مواهبهم. 
-	الحرص على التغطية الإعلامية الوافية، والمستمرة فى وسائل الإعلام كافة للمناسبات والفاعليات والأنشطة العلمية والتعليمية والفنية والرياضية التى تنظمها الجمعيات والمؤسسات المعنية بدعم الأطفال الموهوبين ورعايتهم.
-	الحرص باستمرار على التغطية الإعلامية الملائمة لإبراز الإنجازات المميزة التى يحققها الأطفال الموهوبون.
-	إتاحة الفرص أمام الأطفال الموهوبين للمشاركة في إنتاج المحتوى الإعلامى وعرض مواهبهم المختلفة، والتعبير عن أفكارهم ورؤاهم، والاستماع إليها بعناية، وتعرف احتياجاتهم واهتماماتهم.
-	تكوين اتجاهات ومعتقدات مجتمعية إيجابية قوية تجاه الأطفال الموهوبين، وأهمية اكتشافهم ورعايتهم وتقدير دورهم فى تنمية المجتمع وتقدمه.
-	
ثامناً :المبادئ المهنية لتعامل الإعلام مع أطفال الشوارع:
التوعية– الأمان والحماية- الدعم والمساندة.
من أهم ما يقتضيه التزام هذه المبادئ:
-	التعريف بطبيعة أطفال الشوارع والعوامل أو الظروف القهرية المختلفة التى أودت بهم إلى الشارع، ولفت الانتباه إلى معاناتهم وحقوقهم .
-	إبراز الآثار السلبية والخطيرة المختلفة، المباشرة وغير المباشرة التى تترتب على وجود بعض أطفال المجتمع دون مأوى، ولا رعاية.
-	العناية بالتناول الإعلامى المنظومى للأطفال فى ظروف صعبة، ومن بينهم أطفال الشوارع، عبر تخصيص مواد محددة فى الوسائل الإعلامية المختلفة.
-	عدم تناول التفاصيل الشخصية المحرجة، ولا المعلومات الأليمة للأطفال، وتجنب انتقاد مظهرهم، أو الاستخفاف بهم.
-	تجنب الاستغلال الإعلامى، وتقديم صورة سلبية مثيرة لأطفال الشوارع، تسهمان فى تهميشهم وعزلهم عن المجتمع ؛ بوصفهم مصدراً من مصادر الخطر.
-	إتاحة فرص مناسبة ومتنوعة أمام أطفال الشوارع؛ للتعبير عن معاناتهم واحتياجاتهم ومشاعرهم، والإجابة عن تساؤلاتهم.
-	إبراز الانتهاكات والاعتداءات التى يتعرض لها أطفال الشوارع، وتوضيح كيفية مواجهتها، والحد منها بوصفها مرحلة من مراحل التعامل مع هؤلاء الأطفال.
-	العمل على تكوين رأى عام داعم لهؤلاء الأطفال، ومناصر لحقوقهم، وإعادة تأهيلهم، ودمجهم فى المجتمع. 
cd 

Paragraph to correct:
${text}`;

    const request = {
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      // No need for generationConfig here; it's set on the model.
    };


    const streamingResp = await model.generateContentStream(request); // Use streaming!

    let correctedText = "";
    for await (const chunk of streamingResp.stream) {
      correctedText += chunk.candidates[0].content.parts[0].text;
    }
     //  Optionally, you could also get the final aggregated response:
     const aggregatedResponse = await streamingResp.response;
    //   console.log(aggregatedResponse); //  For debugging, you can log the full response.

    res.json({
      correctedText: correctedText,
      status: "success"
    });

  } catch (error) {
    console.error("Correction Error:", error);
    res.status(500).json({
      error: "Text correction failed",
      details: error.message // Include the actual error message.
    });
  }
});

// PDF processing endpoint (remains the same, but I've included it for completeness)
app.post('/summarizeFile', upload.single('file'), async (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({
        error: "No file uploaded",
        message: "Please upload a PDF file"
      });
    }

    const data = await pdfParse(req.file.buffer);
    const text = data.text;

    if (!text || text.trim().length === 0) {
      return res.status(400).json({
        error: "Empty file",
        message: "The file contains no readable text"
      });
    }

    res.json({
      text: text,
      status: "success"
    });

  } catch (error) {
    console.error("Error:", error);
    res.status(500).json({
      error: "File processing failed",
      details: error.message
    });
  }
});

// Health check endpoint
app.get('/health', (req, res) => {
  res.status(200).json({
    status: 'healthy',
    service: 'Arabic Text Correction API'
  });
});

// Serve frontend
app.get('/', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// Error handling middleware
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({
    error: 'Internal Server Error',
    message: 'An unexpected error occurred'
  });
});

// Start server
app.listen(port, '0.0.0.0', () => {
  console.log(`Server running on http://localhost:${port}`);
  console.log(`VertexAI configured with project: ${process.env.GCLOUD_PROJECT_ID}`);
});